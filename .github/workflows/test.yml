name: PowerShell Magic CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_run:
    workflows: ["Lint & Auto-fix"]
    types:
      - completed

jobs:
  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    # Skip if triggered by workflow_run and the lint workflow failed
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
    defaults:
      run:
        shell: pwsh

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        # For workflow_run, checkout the branch to get latest commits (including auto-fix commits)
        ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || '' }}
        fetch-depth: 0

    - name: Show trigger context
      run: |
        Write-Host "Event name: ${{ github.event_name }}" -ForegroundColor Cyan
        Write-Host "Operating System: ${{ matrix.os }}" -ForegroundColor Cyan
        Write-Host "Current HEAD: $(git rev-parse HEAD)"
        Write-Host "Latest commit: $(git log -1 --pretty='%h %s')"
        if ("${{ github.event_name }}" -eq "workflow_run") {
          Write-Host "Triggered by: ${{ github.event.workflow_run.name }}" -ForegroundColor Yellow
          Write-Host "Original SHA: ${{ github.event.workflow_run.head_sha }}"
          Write-Host "Branch: ${{ github.event.workflow_run.head_branch }}"
        }

    - name: Setup PowerShell
      run: |
        Write-Host "PowerShell Version: $($PSVersionTable.PSVersion)"
        Write-Host "OS Version: $($PSVersionTable.OS)"

    - name: Install Pester
      run: |
        Write-Host "Installing Pester 5.x for testing..." -ForegroundColor Cyan
        Install-Module -Name Pester -MinimumVersion 5.0.0 -Force -SkipPublisherCheck -Scope CurrentUser
        $pester = Get-Module -Name Pester -ListAvailable | Select-Object -First 1
        Write-Host "Installed Pester version: $($pester.Version)" -ForegroundColor Green

    - name: Run formatting checks
      run: |
        Write-Host "Running PowerShell formatting checks..." -ForegroundColor Cyan
        ./Format-PowerShell.ps1 -Check
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Formatting check failed"
          exit $LASTEXITCODE
        }

    - name: Run markdown lint
      if: matrix.os == 'ubuntu-latest'
      run: |
        Write-Host "Running markdownlint with auto-fix..." -ForegroundColor Cyan
        if (-not (Get-Command npx -ErrorAction SilentlyContinue)) {
          Write-Error "npx (Node.js) is required to run markdownlint-cli"
          exit 1
        }
        npx markdownlint-cli@0.41.0 --config .markdownlint.json --fix . --ignore CHANGELOG.md
        git diff --name-only --exit-code

    - name: Run unit tests
      run: |
        Write-Host "Running PowerShell unit tests..." -ForegroundColor Cyan
        ./Tests/Test-PowerShellMagic.ps1
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Unit tests failed"
          exit $LASTEXITCODE
        }

    - name: Run comprehensive test suite
      run: |
        Write-Host "Running comprehensive test suite..." -ForegroundColor Cyan
        ./Run-Tests.ps1 -CI
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Test suite failed"
          exit $LASTEXITCODE
        }

    - name: Run Pester tests with code coverage
      run: |
        Write-Host "Running Pester test suite with code coverage..." -ForegroundColor Cyan
        ./Invoke-PesterTests.ps1 -CI -CoverageThreshold 52
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Pester tests failed"
          exit $LASTEXITCODE
        }

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v6
      with:
        name: test-results-${{ matrix.os }}
        path: |
          **/*.log
          **/*.xml
        retention-days: 7

    - name: Upload code coverage
      if: always()
      uses: actions/upload-artifact@v6
      with:
        name: code-coverage-${{ matrix.os }}
        path: |
          Tests/Pester/coverage.xml
          Tests/Pester/testResults.xml
        retention-days: 30

  validate-modules:
    name: Validate Modules (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
    defaults:
      run:
        shell: pwsh

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        # For workflow_run, checkout the branch to get latest commits (including auto-fix commits)
        ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || '' }}
        fetch-depth: 0

    - name: Test module imports
      run: |
        Write-Host "Testing PowerShell module imports on ${{ matrix.os }}..." -ForegroundColor Cyan

        $modules = @(
          "./Modules/QuickJump/QuickJump.psm1",
          "./Modules/Templater/Templater.psm1",
          "./Modules/Unitea/Unitea.psm1"
        )

        $success = $true

        foreach ($module in $modules) {
          try {
            Write-Host "Testing import: $module" -ForegroundColor Yellow
            Import-Module $module -Force -ErrorAction Stop
            Write-Host "Successfully imported: $module" -ForegroundColor Green
            $moduleName = [System.IO.Path]::GetFileNameWithoutExtension($module)
            Remove-Module $moduleName -Force -ErrorAction SilentlyContinue
          }
          catch {
            Write-Error "Failed to import: $module - $($_.Exception.Message)"
            $success = $false
          }
        }

        if (-not $success) {
          Write-Error "Module validation failed"
          exit 1
        }

        Write-Host 'All modules imported successfully!' -ForegroundColor Green

        if ((Test-Path -LiteralPath variable:\LASTEXITCODE)) { exit $LASTEXITCODE }

  security-scan:
    name: Security Scan (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
    defaults:
      run:
        shell: pwsh

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        # For workflow_run, checkout the branch to get latest commits (including auto-fix commits)
        ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || '' }}
        fetch-depth: 0

    - name: Run PSScriptAnalyzer security rules
      run: |
        Write-Host "Running security analysis on ${{ matrix.os }}..." -ForegroundColor Cyan

        # Install PSScriptAnalyzer if not available
        if (!(Get-Module -ListAvailable -Name PSScriptAnalyzer)) {
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
        }

        # Get all PowerShell files (cross-platform compatible path matching)
        $files = Get-ChildItem -Recurse -Include "*.ps1", "*.psm1", "*.psd1" -ErrorAction SilentlyContinue | Where-Object {
          $null -ne $_ -and
          $null -ne $_.FullName -and
          $_.FullName -notmatch '[/\\]\.git[/\\]' -and
          $_.FullName -notmatch '[/\\]bin[/\\]' -and
          $_.FullName -notmatch '[/\\]obj[/\\]'
        }

        if ($null -eq $files -or $files.Count -eq 0) {
          Write-Warning "No PowerShell files found to scan"
          Write-Host "Security scan completed successfully!" -ForegroundColor Green
          return
        }

        Write-Host "Found $($files.Count) PowerShell files to scan" -ForegroundColor Cyan

        $criticalIssues = @()

        foreach ($file in $files) {
          if ($null -eq $file -or $null -eq $file.FullName) {
            Write-Warning "Skipping null or invalid file reference"
            continue
          }

          Write-Host "Scanning: $($file.Name)" -ForegroundColor Yellow

          try {
            $results = Invoke-ScriptAnalyzer -Path $file.FullName -Severity Error, Warning
            $securityIssues = $results | Where-Object { $_.RuleName -like "*Security*" -or $_.Severity -eq "Error" }
          } catch {
            Write-Warning "Failed to analyze $($file.FullName): $($_.Exception.Message)"
            continue
          }

          if ($securityIssues) {
            $criticalIssues += $securityIssues
            foreach ($issue in $securityIssues) {
              Write-Warning "$($file.Name):$($issue.Line) - $($issue.RuleName): $($issue.Message)"
            }
          }
        }

        if ($criticalIssues.Count -gt 0) {
          Write-Error "Security scan found $($criticalIssues.Count) critical issues"
          exit 1
        }

        Write-Host "Security scan completed successfully!" -ForegroundColor Green
